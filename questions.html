<!DOCTYPE html>
<html>
<head>
    <title>Question</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        h3 { font-size: 16px; color: gray; margin-top: 0; text-align: left; }
        h2 { margin-bottom: 20px; font-size: 18px; text-align: left; max-width: 700px; line-height: 1.4; word-wrap: break-word; }
        .correct, .wrong, button, .home-button {
            border-radius: 5px;
            padding: 8px 15px;
            cursor: pointer;
            margin-top: 15px;
            border: none;
        }
        .correct { background-color: green; color: white; }
        .wrong { background-color: red; color: white; }
        button[type="submit"], #submit-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            font-size: 16px;
        }
        button[type="submit"]:hover, #submit-btn:hover { background-color: #45a049; }
        input[type="number"] {
            width: 200px;
            height: 35px;
            font-size: 16px;
            padding: 5px 10px;
            box-sizing: border-box;
        }
        .answer-box {
            margin-top: 15px;
            background: #f2f2f2;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-line;
            font-family: monospace;
        }
        .home-button {
            display: inline-block;
            background-color: #fff8b3;
            color: #333;
            padding: 8px 15px;
            border-radius: 5px;
            text-decoration: none;
            margin-top: 20px;
            font-weight: bold;
            border: 1px solid #e6d96f;
        }
        .home-button:hover { background-color: #ffef85; }
        .hidden { display: none; }
    </style>
</head>
<body>

<!-- Container for question info -->
<div id="question-container">
    <h3 id="question-label"></h3>
    <h2 id="question-text"></h2>
    <form id="answer-form" onsubmit="submitAnswer(event)">
        <div id="options-container"></div>
        <input id="typein-input" type="number" class="hidden" required>
        <br>
        <button type="submit" id="submit-btn">Submit</button>
    </form>
</div>

<div id="result-container"></div>

<!-- Back to Home button -->
<br><a href="/" class="home-button">Choose Again</a>

<script>
const marks = "{{ marks }}";
const questionType = "{{ question_type }}";

let currentQuestion = null;

// On page load, fetch question from API
window.onload = function() {
    fetchQuestion();
};

// Fetch a question from the API (use marks and question_type as preferred)
function fetchQuestion() {
    fetch('/api/question', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ marks: marks, question_type: questionType })
    })
    .then(response => response.json())
    .then(q => {
        currentQuestion = q;
        document.getElementById('question-label').innerText = q.label;
        document.getElementById('question-text').innerText = q.question;

        renderOptions(q);
        document.getElementById('result-container').innerHTML = '';
    })
    .catch(error => {
        console.error("Error fetching question:", error);
        alert("Error fetching question. Please try refreshing the page.");
    });
}

// Render MCQ or type-in options based on question type
function renderOptions(q) {
    let optionsDiv = document.getElementById('options-container');
    optionsDiv.innerHTML = '';

    let typein = document.getElementById('typein-input');

    if (q.type === 'mcq') {
        // Hide and disable required for type-in when showing MCQs
        typein.className = 'hidden';
        typein.required = false;  

        q.options.forEach((opt) => {
            let label = document.createElement('label');
            let input = document.createElement('input');
            input.type = 'radio';
            input.name = 'user_answer';

            // Remove non-digit/non-minus from the value
            let cleanedValue = opt.value.replace(/[^0-9\-]/g, "");
            console.log(`Raw: "${opt.value}", Cleaned: "${cleanedValue}"`);

            input.value = cleanedValue;
            input.required = true;

            label.appendChild(input);
            label.appendChild(document.createTextNode(` ${opt.label}. ${opt.value}`));

            optionsDiv.appendChild(label);
            optionsDiv.appendChild(document.createElement('br'));
        });

    } else {
        // Show and require the type-in input
        typein.className = '';
        typein.required = true;
        typein.value = '';
        typein.name = 'user_answer';
        typein.placeholder = `Enter answer in ${q.category.includes('density') ? '°C' : 'ft'}`;
    }
}




// Form submission handler
function submitAnswer(event) {
    event.preventDefault();

    let user_answer = '';
    if (currentQuestion.type === 'mcq') {
        let radios = document.getElementsByName('user_answer');
        for (let r of radios) {
            if (r.checked) {
                user_answer = r.value;
                break;
            }
        }
        if (!user_answer) {
            alert("Please select an option before submitting.");
            return;
        }
    } else {
        user_answer = document.getElementById('typein-input').value.trim();
        if (!user_answer) {
            alert("Please enter your answer before submitting.");
            return;
        }
    }

    fetch('/api/check_answer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            user_answer: user_answer,
            correct_answer: currentQuestion.correct_answer,
            marks: currentQuestion.marks,
            category: currentQuestion.category,
            label: currentQuestion.label
        })
    })
    .then(resp => resp.json())
    .then(res => {
        showResult(res);
    })
    .catch(err => {
        console.error("Error submitting answer:", err);
        alert("There was a problem submitting your answer. Please try again.");
    });
}

// Show result and answer reveal
function showResult(res) {
    let answerHtml = '';
    if (res.is_correct) {
        answerHtml = `<button id="show-answer-btn" class="correct" onclick="showAnswer()">Show Answer</button>`;
    } else {
        answerHtml = `<button id="show-answer-btn" class="wrong" onclick="showAnswer()">Show Answer</button>`;
    }
    document.getElementById('result-container').innerHTML = answerHtml;
}

// Show solution steps
function showAnswer() {
    let q = currentQuestion;
    let solution = '';
    if (q.category === 'pressure') {
        solution = `<div id="answer-section" class="answer-box">
            1. formula: PA = Elev + (1013 - Qnh) × 30
            <br>2. substitute: PA = ${q.elev} + (1013 - ${q.qnh}) × 30
            <br>3. answer: ${q.correct_answer} ft
        </div>`;
    } else if (q.category === 'pressure_2mark') {
        solution = `<div id="answer-section" class="answer-box">
            1. Formula: Pressure Altitude = Elevation + (1013 - QNH) × 30
            <br>2. Elevation lookup: ${q.airport} = ${q.elev} ft
            <br>3. Substitution: PA = ${q.elev} + (1013 - ${q.qnh}) × 30
            <br>4. Calculation: = ${q.elev} + ${q.calculation_value}
            <br>5. Rounded: ${q.correct_answer} ft
        </div>`;
    } else if (q.category === 'density') {
        solution = `<div id="answer-section" class="answer-box">
            1. formula: ISA Temp = 15 − 2 × (thousands of feet)
            <br>2. substitute: ISA Temp = 15 − 2 × (${(q.pressure_height/1000).toFixed(1)}) = ${q.isa_temp}
            <br>ISA Dev = ${q.oat} − ${q.isa_temp} = ${q.correct_answer}
            <br>3. answer: ${q.correct_answer} °C
        </div>`;
    } else if (q.category === 'density_2mark') {
        solution = `<div id="answer-section" class="answer-box">
            1. PH = Elev + (1013 - QNH) × 30
            <br>2. Elev lookup: ${q.airport} = ${q.elev} ft
            <br>3. PH = ${q.ph_rounded} ft
            <br>4. ISA Temp = 15 - 2 × (${(q.ph_rounded/1000).toFixed(2)}) = ${q.isa_temp} °C
            <br>5. ISA Dev = ${q.oat} - ${q.isa_temp} = ${q.isa_dev} °C
            <br>6. Temp correction = ${q.isa_dev} × 120 = ${q.temp_effect} ft
            <br>7. DH = ${q.ph_rounded} + ${q.temp_effect} = ${q.correct_answer} ft
        </div>`;
    }
    document.getElementById('result-container').innerHTML += solution;
}

</script>

</body>
</html>
